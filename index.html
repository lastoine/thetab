<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The TAB - MTG UBI ANN</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Supabase Configuration and Client ---
        const supabaseUrl = "https://pnnmxmfstynzyhvdfdyw.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBubm14bWZzdHluenlodmRmZHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyOTU1NjQsImV4cCI6MjA2ODg3MTU2NH0.fzuomyiBGqk07noz_qW0dmZAqg3eulpXQiczoE26DWU";
        const { createClient } = supabase; 
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // --- SVG Icons ---
        const SearchIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;
        const Trash2Icon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const PlusCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>;
        const ScaleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 16.5l4-4-4-4"></path><path d="M8 7.5l-4 4 4 4"></path><path d="M2 11.5h20"></path><path d="M12 3v18"></path></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const GridIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>;
        const ExternalLinkIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block ml-1 opacity-60"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>;
        const UndoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>;
        const LogOutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const ArrowRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>;
        const ArrowLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const SunIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const MoonIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const StoreIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9.5L12 4l9 5.5M3 9.5v10.5h18V9.5M2 20h20M15 13H9v7h6v-7z"></path></svg>;

        // --- Auth Component ---
        function Auth({ supabase }) {
            const [view, setView] = useState('sign_in'); // sign_in, sign_up, forgot_password
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nickname, setNickname] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setMessage('');

                try {
                    let response;
                    if (view === 'sign_up') {
                        if (!nickname.trim()) throw new Error("Nickname is required.");
                        response = await supabase.auth.signUp({ 
                            email, 
                            password,
                            options: { data: { nickname: nickname.trim() } }
                        });
                    } else if (view === 'sign_in') {
                        response = await supabase.auth.signInWithPassword({ email, password });
                    }
                    if (response.error) throw response.error;
                } catch (error) {
                    if (error.message.includes('profiles_nickname_key')) {
                        setError('This nickname is already taken. Please choose another one.');
                    } else {
                        setError(error.error_description || error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handlePasswordReset = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setMessage('');
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email);
                    if (error) throw error;
                    setMessage('Password reset instructions have been sent to your email.');
                } catch (error) {
                    setError(error.error_description || error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center">
                    <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
                        {view === 'forgot_password' ? (
                            <>
                                <h2 className="text-3xl font-bold text-center text-blue-700 mb-6">Reset Password</h2>
                                {message && <p className="bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-center">{message}</p>}
                                {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</p>}
                                <form onSubmit={handlePasswordReset} className="space-y-6">
                                    <div>
                                        <label htmlFor="email" className="text-sm font-medium text-gray-700">Email address</label>
                                        <input id="email" name="email" type="email" required value={email} onChange={(e) => setEmail(e.target.value)}
                                            className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                    </div>
                                    <div>
                                        <button type="submit" disabled={loading}
                                            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-400">
                                            {loading ? 'Sending...' : 'Send Reset Instructions'}
                                        </button>
                                    </div>
                                </form>
                                <p className="mt-6 text-center text-sm text-gray-600">
                                    <button onClick={() => setView('sign_in')} className="font-medium text-blue-600 hover:text-blue-500">
                                        Back to Sign In
                                    </button>
                                </p>
                            </>
                        ) : (
                            <>
                                <h2 className="text-3xl font-bold text-center text-blue-700 mb-6">{view === 'sign_up' ? 'Create Account' : 'Sign In'}</h2>
                                {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</p>}
                                <form onSubmit={handleAuthAction} className="space-y-6">
                                    {view === 'sign_up' && (
                                        <div>
                                            <label htmlFor="nickname" className="text-sm font-medium text-gray-700">Nickname</label>
                                            <input id="nickname" name="nickname" type="text" required maxLength="25" value={nickname} onChange={(e) => setNickname(e.target.value)}
                                                className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                        </div>
                                    )}
                                    <div>
                                        <label htmlFor="email" className="text-sm font-medium text-gray-700">Email address</label>
                                        <input id="email" name="email" type="email" required value={email} onChange={(e) => setEmail(e.target.value)}
                                            className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                    </div>
                                    <div>
                                        <label htmlFor="password"className="text-sm font-medium text-gray-700">Password</label>
                                        <input id="password" name="password" type="password" required value={password} onChange={(e) => setPassword(e.target.value)}
                                            className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                    </div>
                                    {view === 'sign_in' && (
                                        <div className="text-right text-sm">
                                            <button type="button" onClick={() => setView('forgot_password')} className="font-medium text-blue-600 hover:text-blue-500">
                                                Forgot password?
                                            </button>
                                        </div>
                                    )}
                                    <div>
                                        <button type="submit" disabled={loading}
                                            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-400">
                                            {loading ? 'Processing...' : (view === 'sign_up' ? "Sign Up" : 'Sign In')}
                                        </button>
                                    </div>
                                </form>
                                <p className="mt-6 text-center text-sm text-gray-600">
                                    {view === 'sign_up' ? 'Already have an account?' : "Don't have an account?"}
                                    <button onClick={() => setView(view === 'sign_up' ? 'sign_in' : 'sign_up')} className="font-medium text-blue-600 hover:text-blue-500 ml-1">
                                        {view === 'sign_up' ? 'Sign In' : "Sign Up"}
                                    </button>
                                </p>
                            </>
                        )}
                    </div>
                </div>
            );
        }
        
        // --- Update Password Component ---
        function UpdatePassword({ supabase }) {
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');

            const handlePasswordUpdate = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setMessage('');
                try {
                    const { error } = await supabase.auth.updateUser({ password });
                    if (error) throw error;
                    setMessage('Password updated successfully! You can now sign in with your new password.');
                } catch (error) {
                    setError(error.error_description || error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center">
                    <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
                        <h2 className="text-3xl font-bold text-center text-blue-700 mb-6">Choose a New Password</h2>
                        {message && <p className="bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-center">{message}</p>}
                        {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</p>}
                        <form onSubmit={handlePasswordUpdate} className="space-y-6">
                            <div>
                                <label htmlFor="new-password"className="text-sm font-medium text-gray-700">New Password</label>
                                <input id="new-password" name="password" type="password" required value={password} onChange={(e) => setPassword(e.target.value)}
                                    className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                            </div>
                            <div>
                                <button type="submit" disabled={loading}
                                    className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-400">
                                    {loading ? 'Updating...' : 'Update Password'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Main App Component ---
        function App() {
            const [session, setSession] = useState(null);
            const [isPasswordRecovery, setIsPasswordRecovery] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setIsLoading(false);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (event === 'PASSWORD_RECOVERY') {
                        setIsPasswordRecovery(true);
                    }
                    setSession(session);
                });

                return () => subscription.unsubscribe();
            }, []);

            if (isLoading) {
                return <div className="text-center p-10">Initializing...</div>;
            }
            
            if (isPasswordRecovery) {
                return <UpdatePassword supabase={supabaseClient} />;
            }

            if (!session) {
                return <Auth supabase={supabaseClient} />;
            } else {
                return <TheTabApp user={session.user} />;
            }
        }

        function TheTabApp({ user }) {
          const [profiles, setProfiles] = useState([]);
          const [currentUserProfile, setCurrentUserProfile] = useState(null);
          const [transactions, setTransactions] = useState([]);
          const [cart, setCart] = useState([]);
          const [currentView, setCurrentView] = useState('search');
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [theme, setTheme] = useState(localStorage.getItem('app-theme') || 'light');
          const [hoveredCard, setHoveredCard] = useState(null);

          useEffect(() => {
            const root = window.document.documentElement;
            root.classList.remove('light', 'dark');
            if (theme === 'dark') {
                root.classList.add('dark');
            }
            localStorage.setItem('app-theme', theme);
          }, [theme]);

          const fetchData = useCallback(async () => {
              setIsLoading(true);
              setError(null);
              try {
                  const { data: profilesData, error: profilesError } = await supabaseClient.from('profiles').select('*');
                  if (profilesError) throw profilesError;
                  setProfiles(profilesData);

                  const profile = profilesData.find(p => p.id === user.id);
                  setCurrentUserProfile(profile);

                  const { data: transactionsData, error: transactionsError } = await supabaseClient.from('transactions').select('*');
                  if (transactionsError) throw transactionsError;
                  setTransactions(transactionsData);
              } catch (err) {
                  console.error("Data fetching error:", err.message);
                  setError('Could not fetch data from the database.');
              } finally {
                  setIsLoading(false);
              }
          }, [user.id]);

          useEffect(() => {
              fetchData();
          }, [fetchData]);

          const handleSignOut = async () => {
              await supabaseClient.auth.signOut();
          };

          const handleProfileUpdate = (updatedProfile) => {
            setCurrentUserProfile(updatedProfile);
            setProfiles(prevProfiles => prevProfiles.map(p => p.id === updatedProfile.id ? updatedProfile : p));
          };

          const addToCart = useCallback((card) => { setCart(prev => [...prev, { ...card, finalPrice: card.price || 0, lang: 'EN', cartItemId: Date.now() + Math.random() }]); }, []);
          const removeFromCart = useCallback((id) => { setCart(prev => prev.filter(item => item.cartItemId !== id)); }, []);
          const updateCartItemPrice = useCallback((id, price) => { setCart(prev => prev.map(item => item.cartItemId === id ? { ...item, finalPrice: price } : item)); }, []);
          const updateCartItemLang = useCallback((id, lang) => { setCart(prev => prev.map(item => item.cartItemId === id ? { ...item, lang: lang } : item)); }, []);

          const addTransaction = useCallback(async (tx) => {
            try {
              const { data, error } = await supabaseClient.from('transactions').insert([tx]).select();
              if (error) throw error;
              setTransactions(prev => [...prev, data[0]]);
              setCart([]);
              setCurrentView('transactions');
            } catch (e) { alert("Error: " + e.message); }
          }, []);

          const updateTransactionCard = useCallback(async (txId, itemId, field, value) => {
            setTransactions(prev => {
              const newTxs = [...prev];
              const tx = newTxs.find(t => t.id === txId);
              if (!tx) return prev;
              
              const updatedCards = tx.cards.map(c => 
                c.cartItemId === itemId ? { ...c, [field]: value } : c
              );
              
              const newTotal = field === 'finalPrice' ? updatedCards.reduce((sum, c) => sum + (c.finalPrice || 0), 0) : tx.total;
              
              supabaseClient.from('transactions').update({ cards: updatedCards, total: newTotal }).eq('id', txId).then(r => { if (r.error) alert(r.error.message); });
              
              return newTxs.map(t => t.id === txId ? { ...t, cards: updatedCards, total: newTotal } : t);
            });
          }, []);

          const toggleTransactionStatus = useCallback(async (txId) => {
            const tx = transactions.find(t => t.id === txId);
            if (!tx) return;
            const newStatus = tx.status === 'cancelled' ? 'active' : 'cancelled';
            try {
              const { data, error } = await supabaseClient.from('transactions').update({ status: newStatus }).eq('id', txId).select();
              if (error) throw error;
              setTransactions(prev => prev.map(t => t.id === txId ? data[0] : t));
            } catch (e) { alert("Error: " + e.message); }
          }, [transactions]);

          const renderView = () => {
            if (isLoading) return <div className="text-center p-10 dark:text-white">Loading data...</div>;
            if (error) return <div className="text-center text-red-500 p-10">{error}</div>;
            switch (currentView) {
              case 'search': return <SearchAndCartView {...{ cart, addToCart, removeFromCart, updateCartItemPrice, updateCartItemLang, profiles, addTransaction, currentUserProfile }} />;
              case 'transactions': return <TransactionsView {...{ transactions, profiles, updateTransactionCard, toggleTransactionStatus, currentUserProfile, setHoveredCard }} />;
              case 'balance': return <BalanceDashboard {...{ transactions, profiles, addTransaction, currentUserProfile }} />;
              case 'matrix': return <BalanceMatrix {...{ transactions, profiles }} />;
              case 'profile': return <ProfileView user={user} profile={currentUserProfile} onProfileUpdate={handleProfileUpdate} />;
              case 'users': return <UsersView profiles={profiles} />;
              default: return <div>Welcome</div>;
            }
          };

          const ThemeSwitcher = () => {
            const toggleTheme = () => {
                const themes = ['light', 'dark', 'cardmarket'];
                const currentIndex = themes.indexOf(theme);
                const nextIndex = (currentIndex + 1) % themes.length;
                setTheme(themes[nextIndex]);
            };

            return (
                <button onClick={toggleTheme} className="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700">
                    {theme === 'light' && <MoonIcon />}
                    {theme === 'dark' && <StoreIcon />}
                    {theme === 'cardmarket' && <SunIcon />}
                </button>
            );
          };
          
          const CardMarketHeader = () => (
            <header className="bg-[#0e2454] text-white shadow-md">
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div className="flex-shrink-0">
                             <h1 className="text-2xl font-bold tracking-tight text-white">TheTab</h1>
                        </div>
                        <div className="flex-1 flex items-center justify-center space-x-1 sm:space-x-2">
                            <button onClick={() => setCurrentView('search')} className={`flex items-center gap-2 px-3 py-2 text-sm rounded-md ${currentView === 'search' ? 'text-yellow-400' : 'hover:text-yellow-400'}`}><SearchIcon/> Search</button>
                            <button onClick={() => setCurrentView('transactions')} className={`flex items-center gap-2 px-3 py-2 text-sm rounded-md ${currentView === 'transactions' ? 'text-yellow-400' : 'hover:text-yellow-400'}`}><ListIcon/> History</button>
                            <button onClick={() => setCurrentView('balance')} className={`flex items-center gap-2 px-3 py-2 text-sm rounded-md ${currentView === 'balance' ? 'text-yellow-400' : 'hover:text-yellow-400'}`}><ScaleIcon/> Balances</button>
                            <button onClick={() => setCurrentView('matrix')} className={`flex items-center gap-2 px-3 py-2 text-sm rounded-md ${currentView === 'matrix' ? 'text-yellow-400' : 'hover:text-yellow-400'}`}><GridIcon/> Matrix</button>
                            <button onClick={() => setCurrentView('users')} className={`flex items-center gap-2 px-3 py-2 text-sm rounded-md ${currentView === 'users' ? 'text-yellow-400' : 'hover:text-yellow-400'}`}><UsersIcon/> Users</button>
                            <button onClick={() => setCurrentView('profile')} className={`p-2 rounded-full ${currentView === 'profile' ? 'text-yellow-400' : 'hover:text-yellow-400'}`}><UserIcon /></button>
                        </div>
                        <div className="flex items-center">
                            <ThemeSwitcher />
                            <button onClick={handleSignOut} className="p-2 rounded-full hover:text-yellow-400" title="Sign Out"><LogOutIcon /></button>
                        </div>
                    </div>
                </div>
            </header>
          );

          if (theme === 'cardmarket') {
              return (
                  <div className="h-screen flex flex-col bg-gray-200">
                      <CardMarketHeader />
                      <main className="flex-1 p-4 sm:p-6 md:p-8 overflow-y-scroll">{renderView()}</main>
                      {hoveredCard && <img src={hoveredCard} className="fixed z-30 w-56 rounded-lg shadow-2xl pointer-events-none" style={{ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }} />}
                  </div>
              )
          }

          return (
            <div className="bg-white dark:bg-slate-800 text-gray-800 dark:text-slate-200 h-screen font-sans flex overflow-hidden">
              <nav className="p-4 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-700 flex flex-col items-center space-y-4 shrink-0 shadow-md">
                <div className="flex-grow">
                    <button onClick={() => setCurrentView('search')} className={`p-3 rounded-lg ${currentView === 'search' ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700'}`} title="Search & Cart"><SearchIcon /></button>
                    <button onClick={() => setCurrentView('transactions')} className={`p-3 mt-2 rounded-lg ${currentView === 'transactions' ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700'}`} title="Transactions"><ListIcon /></button>
                    <button onClick={() => setCurrentView('balance')} className={`p-3 mt-2 rounded-lg ${currentView === 'balance' ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700'}`} title="Balances"><ScaleIcon /></button>
                    <button onClick={() => setCurrentView('matrix')} className={`p-3 mt-2 rounded-lg ${currentView === 'matrix' ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700'}`} title="Matrix"><GridIcon /></button>
                    <button onClick={() => setCurrentView('users')} className={`p-3 mt-2 rounded-lg ${currentView === 'users' ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700'}`} title="Users"><UsersIcon /></button>
                    <button onClick={() => setCurrentView('profile')} className={`p-3 mt-2 rounded-lg ${currentView === 'profile' ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700'}`} title="My Profile"><UserIcon /></button>
                </div>
                <div className="shrink-0 text-center">
                    {currentUserProfile && (
                        <button onClick={() => setCurrentView('profile')} className="mb-2 px-2 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 w-full text-center" title="Go to your profile">
                            <span className="text-xs text-gray-500 dark:text-slate-400">Logged in as</span>
                            <span className="text-sm font-semibold text-blue-700 dark:text-blue-400 block truncate" title={currentUserProfile.nickname}>
                                {currentUserProfile.nickname}
                            </span>
                        </button>
                    )}
                    <button onClick={handleSignOut} className="p-3 rounded-lg text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700" title="Sign Out"><LogOutIcon /></button>
                </div>
              </nav>
              <main className="flex-1 p-4 sm:p-6 md:p-8 overflow-y-scroll bg-gray-50 dark:bg-slate-800 relative">
                <div className="absolute top-4 right-4 z-20">
                    <ThemeSwitcher />
                </div>
                {renderView()}
                {hoveredCard && <img src={hoveredCard} className="fixed z-30 w-56 rounded-lg shadow-2xl pointer-events-none" style={{ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }} />}
              </main>
            </div>
          );
        }

        // --- Profile View Component ---
        const ProfileView = ({ user, profile, onProfileUpdate }) => {
            const [nickname, setNickname] = useState(profile?.nickname || '');
            const [firstName, setFirstName] = useState(profile?.first_name || '');
            const [lastName, setLastName] = useState(profile?.last_name || '');
            const [wishlistUrl, setWishlistUrl] = useState(profile?.wishlist_url || '');
            const [tradelistUrl, setTradelistUrl] = useState(profile?.tradelist_url || '');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            useEffect(() => {
                setNickname(profile?.nickname || '');
                setFirstName(profile?.first_name || '');
                setLastName(profile?.last_name || '');
                setWishlistUrl(profile?.wishlist_url || '');
                setTradelistUrl(profile?.tradelist_url || '');
            }, [profile]);

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                try {
                    const updates = {
                        id: user.id,
                        nickname: nickname.trim(),
                        first_name: firstName.trim(),
                        last_name: lastName.trim(),
                        wishlist_url: wishlistUrl.trim(),
                        tradelist_url: tradelistUrl.trim(),
                        updated_at: new Date(),
                    };
                    const { data, error } = await supabaseClient.from('profiles').upsert(updates).select().single();
                    if (error) throw error;
                    onProfileUpdate(data);
                    setMessage('Profile updated successfully!');
                } catch (error) {
                    if (error.message.includes('profiles_nickname_key')) {
                      setMessage('Error: This nickname is already taken.');
                    } else {
                      setMessage('Error: ' + error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-blue-700 dark:text-blue-400 mb-6">My Profile</h1>
                    <div className="max-w-2xl bg-white dark:bg-slate-900 p-8 rounded-lg shadow-sm border border-gray-200 dark:border-slate-700">
                        <form onSubmit={handleUpdateProfile} className="space-y-6">
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700 dark:text-slate-300">Email</label>
                                <input id="email" type="text" value={user.email} disabled className="mt-1 w-full p-3 bg-gray-200 dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg cursor-not-allowed"/>
                            </div>
                            <div>
                                <label htmlFor="profile-nickname" className="block text-sm font-medium text-gray-700 dark:text-slate-300">Nickname</label>
                                <input id="profile-nickname" type="text" value={nickname} onChange={(e) => setNickname(e.target.value)} required maxLength="25" className="mt-1 w-full p-3 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label htmlFor="firstName" className="block text-sm font-medium text-gray-700 dark:text-slate-300">First Name</label>
                                    <input id="firstName" type="text" value={firstName} onChange={(e) => setFirstName(e.target.value)} className="mt-1 w-full p-3 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                </div>
                                <div>
                                    <label htmlFor="lastName" className="block text-sm font-medium text-gray-700 dark:text-slate-300">Last Name</label>
                                    <input id="lastName" type="text" value={lastName} onChange={(e) => setLastName(e.target.value)} className="mt-1 w-full p-3 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                </div>
                            </div>
                            <div>
                                <label htmlFor="wishlistUrl" className="block text-sm font-medium text-gray-700 dark:text-slate-300">Wishlist URL</label>
                                <input id="wishlistUrl" type="url" value={wishlistUrl} onChange={(e) => setWishlistUrl(e.target.value)} className="mt-1 w-full p-3 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                            </div>
                            <div>
                                <label htmlFor="tradelistUrl" className="block text-sm font-medium text-gray-700 dark:text-slate-300">Tradelist URL</label>
                                <input id="tradelistUrl" type="url" value={tradelistUrl} onChange={(e) => setTradelistUrl(e.target.value)} className="mt-1 w-full p-3 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                            </div>
                            <div className="flex items-center justify-end gap-4">
                                {message && <p className={`text-sm ${message.includes('Error') ? 'text-red-600' : 'text-green-600'}`}>{message}</p>}
                                <button type="submit" disabled={loading} className="py-2 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors disabled:bg-blue-400">
                                    {loading ? 'Saving...' : 'Save'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        // --- Users View Component ---
        const UsersView = ({ profiles }) => {
            const getProfileFullName = (profile) => {
                if (!profile) return '';
                const fullName = `${profile.first_name || ''} ${profile.last_name || ''}`.trim();
                return fullName || profile.nickname;
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-blue-700 dark:text-blue-400 mb-6">Users List</h1>
                    <div className="bg-white dark:bg-slate-900 rounded-lg p-4 border border-gray-200 dark:border-slate-700 shadow-sm">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-500 dark:text-slate-400 uppercase bg-gray-50 dark:bg-slate-800">
                                    <tr>
                                        <th className="px-6 py-3">Nickname</th>
                                        <th className="px-6 py-3">Wishlist</th>
                                        <th className="px-6 py-3">Tradelist</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200 dark:divide-slate-700">
                                    {profiles.map(profile => (
                                        <tr key={profile.id} className="hover:bg-gray-50 dark:hover:bg-slate-800">
                                            <td className="px-6 py-4 font-medium text-gray-900 dark:text-slate-200" title={getProfileFullName(profile)}>{profile.nickname}</td>
                                            <td className="px-6 py-4">
                                                {profile.wishlist_url ? (
                                                    <a href={profile.wishlist_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">
                                                        View Wishlist <ExternalLinkIcon />
                                                    </a>
                                                ) : (
                                                    <span className="text-gray-400 dark:text-slate-500">Not provided</span>
                                                )}
                                            </td>
                                            <td className="px-6 py-4">
                                                {profile.tradelist_url ? (
                                                    <a href={profile.tradelist_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">
                                                        View Tradelist <ExternalLinkIcon />
                                                    </a>
                                                ) : (
                                                    <span className="text-gray-400 dark:text-slate-500">Not provided</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Other components (Search, Cart, Transactions, Balance) ---
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
                return () => { clearTimeout(handler); };
            }, [value, delay]);
            return debouncedValue;
        }

        const SearchAndCartView = React.memo(({ cart, addToCart, removeFromCart, updateCartItemPrice, updateCartItemLang, profiles, addTransaction, currentUserProfile }) => {
          const [searchResults, setSearchResults] = useState([]);
          const [query, setQuery] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);
          const debouncedQuery = useDebounce(query, 500);

          const handleSearch = useCallback(async (searchQuery) => {
            if (!searchQuery) { setSearchResults([]); return; };
            setIsLoading(true); setError(null);
            try {
              const response = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(`${searchQuery.trim()} unique:prints`)}`);
              if (!response.ok) { const errData = await response.json(); throw new Error(errData.details || 'Card not found.'); }
              const data = await response.json();
              const processedResults = data.data.flatMap(card => 
                card.finishes.map(finish => ({
                  id: card.id, name: card.name, set_name: card.set_name, set: card.set, collector_number: card.collector_number, rarity: card.rarity, finish: finish,
                  price: finish === 'foil' ? card.prices.eur_foil : card.prices.eur,
                  image_uri: card.image_uris?.small || 'https://placehold.co/146x204/e0e7ff/3730a3?text=No+Image',
                  scryfall_uri: card.scryfall_uri, purchase_uris: card.purchase_uris
                }))
              );
              setSearchResults(processedResults);
            } catch (err) { setError(err.message); setSearchResults([]); }
            setIsLoading(false);
          }, []);

          useEffect(() => { handleSearch(debouncedQuery); }, [debouncedQuery, handleSearch]);

          return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-2">
                <h1 className="text-3xl font-bold text-blue-700 dark:text-blue-400 mb-4">Card Search</h1>
                <div className="flex gap-2 mb-4">
                  <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} placeholder='Start typing a card name...' className="flex-grow bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none text-gray-900 dark:text-slate-200"/>
                </div>
                <div className="bg-white dark:bg-slate-900 rounded-lg p-4 border border-gray-200 dark:border-slate-700 shadow-sm min-h-[60vh]">
                  {isLoading && <p className="text-gray-500 dark:text-slate-400 text-center py-12">Searching...</p>}
                  {error && <p className="text-red-600 text-center py-12">{error}</p>}
                  {!isLoading && searchResults.length === 0 && !error && <p className="text-gray-500 dark:text-slate-400 text-center py-12">Search results will be displayed here.</p>}
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    {searchResults.map(card => (
                      <div key={`${card.id}-${card.finish}`} className="bg-gray-50 dark:bg-slate-800 rounded-lg p-2 flex flex-col items-center text-center border border-gray-200 dark:border-slate-700 hover:shadow-md transition-shadow">
                        <a href={card.scryfall_uri} target="_blank" rel="noopener noreferrer"><img src={card.image_uri} alt={card.name} className="rounded-md w-full mb-2" /></a>
                        <h3 className="font-semibold text-sm text-gray-900 dark:text-slate-200">{card.name} {card.finish === 'foil' && <span className="text-blue-500">(Foil)</span>}</h3>
                        <p className="text-xs text-gray-500 dark:text-slate-400">{card.set_name}</p>
                        <p className="font-bold text-blue-600 dark:text-blue-400 text-sm my-1">{card.price ? `${card.price} â‚¬` : 'N/A'}</p>
                        <button onClick={() => addToCart(card)} className="bg-blue-500 text-white text-xs w-full py-1 rounded-md mt-auto hover:bg-blue-600 transition-colors">Add to Cart</button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              <div className="lg:sticky lg:top-8 h-fit">
                <h2 className="text-2xl font-bold text-blue-700 dark:text-blue-400 mb-4 flex items-center"><span className="ml-2">Cart</span></h2>
                <Cart cart={cart} removeFromCart={removeFromCart} updateCartItemPrice={updateCartItemPrice} updateCartItemLang={updateCartItemLang} profiles={profiles} addTransaction={addTransaction} currentUserProfile={currentUserProfile} />
              </div>
            </div>
          );
        });

        const Cart = React.memo(({ cart, removeFromCart, updateCartItemPrice, updateCartItemLang, profiles, addTransaction, currentUserProfile }) => {
            const [buyerId, setBuyerId] = useState('');
            const [sellerId, setSellerId] = useState(currentUserProfile?.id || '');

            useEffect(() => {
                if (!currentUserProfile) return;
                setSellerId(currentUserProfile.id);

                const otherUsers = profiles.filter(p => p.id !== currentUserProfile.id);
                if (otherUsers.length > 0 && !buyerId) {
                    setBuyerId(otherUsers[0].id);
                } else if (otherUsers.length === 0) {
                    setBuyerId(currentUserProfile.id);
                }
            }, [profiles, currentUserProfile, buyerId]);

            const handleRecordTransaction = useCallback(() => {
                if (!buyerId || !sellerId || cart.length === 0) {
                    alert('Please select a buyer, a seller, and at least one card.'); return;
                }
                if (buyerId === sellerId) {
                    alert("Buyer and Seller cannot be the same person."); return;
                }
                
                const isAdmin = currentUserProfile?.role === 'admin';
                const is_involved = currentUserProfile?.id === buyerId || currentUserProfile?.id === sellerId;
                if (!isAdmin && !is_involved) {
                    alert("You can only record transactions where you are the buyer or the seller.");
                    return;
                }

                const newTransaction = {
                    buyer: buyerId, seller: sellerId,
                    cards: cart.map(c => ({ ...c, marketPrice: parseFloat(c.price) || 0, finalPrice: parseFloat(c.finalPrice) || 0 })),
                    total: cart.reduce((sum, c) => sum + (parseFloat(c.finalPrice) || 0), 0),
                    status: 'active'
                };
                addTransaction(newTransaction);
            }, [buyerId, sellerId, cart, addTransaction, currentUserProfile]);

            const total = useMemo(() => cart.reduce((sum, c) => sum + (parseFloat(c.finalPrice) || 0), 0).toFixed(2), [cart]);

            const getProfileFullName = (profile) => {
                if (!profile) return '';
                const fullName = `${profile.first_name || ''} ${profile.last_name || ''}`.trim();
                return fullName || profile.nickname;
            };

            return (
                <div className="bg-white dark:bg-slate-900 rounded-lg p-4 flex flex-col border border-gray-200 dark:border-slate-700 shadow-sm max-h-[calc(100vh-8rem)]">
                    <div className="flex-grow overflow-y-auto mb-4 pr-2">
                        {cart.length === 0 ? <p className="text-gray-500 dark:text-slate-400 text-center mt-8">Your cart is empty.</p> :
                            <ul className="space-y-3">
                                {cart.map(card => (
                                    <li key={card.cartItemId} className="flex items-center justify-between bg-gray-100 dark:bg-slate-800 p-2 rounded-lg">
                                        <div className="text-sm flex-grow">
                                            <p className="font-semibold text-gray-900 dark:text-slate-200">{card.name} {card.finish === 'foil' && <span className="text-blue-500">(Foil)</span>}</p>
                                            <p className="text-xs text-gray-500 dark:text-slate-400">{card.set_name}</p>
                                        </div>
                                        <div className="flex items-center">
                                            <input type="text" value={card.lang} onChange={(e) => updateCartItemLang(card.cartItemId, e.target.value.toUpperCase())} className="w-10 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md p-1 text-center font-mono text-gray-900 dark:text-slate-200" maxLength="2" />
                                            <input type="number" value={card.finalPrice} onChange={(e) => updateCartItemPrice(card.cartItemId, e.target.value)} className="w-20 ml-2 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md p-1 text-right font-mono text-gray-900 dark:text-slate-200" step="0.01" />
                                            <span className="ml-1 mr-2 text-gray-600 dark:text-slate-400">â‚¬</span>
                                            <button onClick={() => removeFromCart(card.cartItemId)} className="text-red-500 hover:text-red-700"><Trash2Icon /></button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        }
                    </div>
                    {cart.length > 0 && (
                        <div className="border-t border-gray-200 dark:border-slate-700 pt-4 shrink-0">
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-slate-300">Buyer</label>
                                    <select value={buyerId} onChange={e => setBuyerId(e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2 text-gray-900 dark:text-slate-200">
                                        {profiles.map(p => <option key={p.id} value={p.id} title={getProfileFullName(p)}>{p.nickname}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-slate-300">Seller</label>
                                    <select value={sellerId} onChange={e => setSellerId(e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2 text-gray-900 dark:text-slate-200">
                                        {profiles.map(p => <option key={p.id} value={p.id} title={getProfileFullName(p)}>{p.nickname}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="text-right font-bold text-xl mb-4 text-gray-900 dark:text-slate-200">Total: {total} â‚¬</div>
                            <button onClick={handleRecordTransaction} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">Record Transaction</button>
                        </div>
                    )}
                </div>
            );
        });

        const TransactionsView = React.memo(({ transactions, profiles, updateTransactionCard, toggleTransactionStatus, currentUserProfile, setHoveredCard }) => {
            const [showCancelled, setShowCancelled] = useState(false);
            const [filters, setFilters] = useState({ 
                buyer: 'all', 
                seller: 'all', 
                involved: true,
                startDate: '',
                endDate: ''
            });
            
            useEffect(() => {
                if (currentUserProfile) {
                    setFilters(prev => ({ ...prev, involved: true }));
                }
            }, [currentUserProfile]);

            const profilesById = useMemo(() => profiles.reduce((acc, profile) => {
                acc[profile.id] = profile;
                return acc;
            }, {}), [profiles]);

            const handleFilterChange = (e) => { 
                const { name, value, type, checked } = e.target;
                setFilters(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };
            
            const filteredTransactions = useMemo(() => (transactions || [])
                .filter(tx => showCancelled || tx.status !== 'cancelled')
                .filter(tx => {
                    if (filters.involved && currentUserProfile) {
                        return tx.buyer === currentUserProfile.id || tx.seller === currentUserProfile.id;
                    }
                    return true;
                })
                .filter(tx => filters.buyer === 'all' || tx.buyer === filters.buyer)
                .filter(tx => filters.seller === 'all' || tx.seller === filters.seller)
                .filter(tx => {
                    if (!filters.startDate && !filters.endDate) return true;
                    const txDate = new Date(tx.created_at); txDate.setHours(0,0,0,0);
                    const startDate = filters.startDate ? new Date(filters.startDate) : null;
                    const endDate = filters.endDate ? new Date(filters.endDate) : null;
                    if (startDate && txDate < startDate) return false;
                    if (endDate && txDate > endDate) return false;
                    return true;
                }), [transactions, filters, showCancelled, currentUserProfile]);

            const getProfileData = (id, field) => profilesById[id]?.[field] || (field === 'nickname' ? 'Unknown User' : '');
            const getProfileFullName = (id) => {
                const p = profilesById[id];
                if (!p) return 'Unknown User';
                const fullName = `${p.first_name || ''} ${p.last_name || ''}`.trim();
                return fullName || p.nickname;
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-blue-700 dark:text-blue-400 mb-6">Transaction History</h1>
                     <div className="bg-white dark:bg-slate-900 p-4 rounded-lg mb-6 border border-gray-200 dark:border-slate-700 shadow-sm grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div className="text-gray-700 dark:text-slate-300">
                            <label className="text-sm font-medium">Buyer</label>
                            <select name="buyer" value={filters.buyer} onChange={handleFilterChange} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2 mt-1">
                                <option value="all">All</option>
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                            </select>
                        </div>
                        <div className="text-gray-700 dark:text-slate-300">
                            <label className="text-sm font-medium">Seller</label>
                            <select name="seller" value={filters.seller} onChange={handleFilterChange} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2 mt-1">
                                <option value="all">All</option>
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                            </select>
                        </div>
                        <div className="text-gray-700 dark:text-slate-300">
                            <label className="text-sm font-medium">Start Date</label>
                            <input type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2 mt-1" />
                        </div>
                        <div className="text-gray-700 dark:text-slate-300">
                            <label className="text-sm font-medium">End Date</label>
                            <input type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2 mt-1" />
                        </div>
                        <div className="flex items-center space-x-4 lg:col-span-4 justify-end text-gray-600 dark:text-slate-300">
                            <div className="flex items-center">
                                <input type="checkbox" id="involved" name="involved" checked={filters.involved} onChange={handleFilterChange} className="h-4 w-4 rounded border-gray-300 dark:border-slate-600 text-blue-600 focus:ring-blue-500" />
                                <label htmlFor="involved" className="ml-2 text-sm">Only show my transactions</label>
                            </div>
                            <div className="flex items-center">
                                <input type="checkbox" id="showCancelled" checked={showCancelled} onChange={() => setShowCancelled(!showCancelled)} className="h-4 w-4 rounded border-gray-300 dark:border-slate-600 text-blue-600 focus:ring-blue-500" />
                                <label htmlFor="showCancelled" className="ml-2 text-sm">Show cancelled</label>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-slate-900 rounded-lg p-4 border border-gray-200 dark:border-slate-700 shadow-sm">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-500 dark:text-slate-400 uppercase bg-gray-50 dark:bg-slate-800">
                                    <tr>
                                        <th className="px-4 py-3">Date</th><th className="px-4 py-3">Buyer</th><th className="px-4 py-3">Seller</th>
                                        <th className="px-4 py-3">Card / Description</th><th className="px-4 py-3">Set</th>
                                        <th className="px-4 py-3">Lang</th>
                                        <th className="px-4 py-3">CardMarket Trend</th>
                                        <th className="px-4 py-3">Final Price</th>
                                        <th className="px-4 py-3 text-right">Total</th><th className="px-4 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200 dark:divide-slate-700">
                                    {filteredTransactions.slice().reverse().map(tx => {
                                        const isCancelled = tx.status === 'cancelled';
                                        const isAdmin = currentUserProfile?.role === 'admin';
                                        const is_involved = currentUserProfile?.id === tx.buyer || currentUserProfile?.id === tx.seller;
                                        const canEdit = isAdmin || is_involved;

                                        return (
                                            <React.Fragment key={tx.id}>
                                                {(tx.cards || []).map((c, index) => {
                                                    const isManual = c.finish === 'manual';
                                                    const rowClass = isManual ? 'bg-blue-50 dark:bg-blue-900/20' : '';
                                                    return (
                                                    <tr key={c.cartItemId || `${c.id}-${c.finish}`} className={`${isCancelled ? 'opacity-40 bg-gray-100 dark:bg-slate-800' : `hover:bg-gray-50 dark:hover:bg-slate-800 ${rowClass}`}`}>
                                                        {index === 0 && (<>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length}>{new Date(tx.created_at).toLocaleDateString('en-GB')}</td>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length} title={getProfileFullName(tx.buyer)}>{getProfileData(tx.buyer, 'nickname')}</td>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length} title={getProfileFullName(tx.seller)}>{getProfileData(tx.seller, 'nickname')}</td>
                                                        </>)}
                                                        
                                                        {isManual ? (
                                                            <td className="px-4 py-4 italic">
                                                                <input type="text" defaultValue={c.name} onBlur={(e) => updateTransactionCard(tx.id, c.cartItemId, 'name', e.target.value)} className="w-full bg-transparent border-0 p-0 focus:ring-0 focus:bg-white dark:focus:bg-slate-700 disabled:cursor-not-allowed" disabled={isCancelled || !canEdit} />
                                                            </td>
                                                        ) : (
                                                            <td className="px-4 py-4 relative" onMouseEnter={() => setHoveredCard(c.image_uri)} onMouseLeave={() => setHoveredCard(null)}>
                                                                <a href={c.scryfall_uri} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">
                                                                    {c.name} {c.finish === 'foil' && '(Foil)'} {c.scryfall_uri && <ExternalLinkIcon />}
                                                                </a>
                                                            </td>
                                                        )}
                                                        
                                                        <td className="px-4 py-4 text-gray-600 dark:text-slate-400">{!isManual && c.set_name}</td>
                                                        <td className="px-4 py-4">
                                                            {!isManual && <input type="text" defaultValue={c.lang} onBlur={(e) => updateTransactionCard(tx.id, c.cartItemId, 'lang', e.target.value.toUpperCase())} className="w-10 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-md p-1 text-center font-mono disabled:bg-gray-100 dark:disabled:bg-slate-700 disabled:cursor-not-allowed" maxLength="2" disabled={isCancelled || !canEdit} />}
                                                        </td>
                                                        <td className="px-4 py-4 font-mono">
                                                            {!isManual && (c.purchase_uris?.cardmarket ? (
                                                                <a href={c.purchase_uris.cardmarket} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">
                                                                    {typeof c.marketPrice === 'number' ? `${c.marketPrice.toFixed(2)} â‚¬` : 'N/A'} <ExternalLinkIcon />
                                                                </a>
                                                            ) : (
                                                                <span>{typeof c.marketPrice === 'number' ? `${c.marketPrice.toFixed(2)} â‚¬` : 'N/A'}</span>
                                                            ))}
                                                        </td>
                                                        <td className="px-4 py-4">
                                                            <div className="flex items-center">
                                                                <input type="number" defaultValue={c.finalPrice} onBlur={(e) => updateTransactionCard(tx.id, c.cartItemId, 'finalPrice', parseFloat(e.target.value) || 0)} className="w-20 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-md p-1 text-right font-mono disabled:bg-gray-100 dark:disabled:bg-slate-700 disabled:cursor-not-allowed" step="0.01" disabled={isCancelled || !canEdit} />
                                                                <span className="ml-1 text-gray-600 dark:text-slate-400">â‚¬</span>
                                                            </div>
                                                        </td>
                                                        {index === 0 && (<>
                                                            <td className="px-4 py-4 text-right font-mono" rowSpan={tx.cards.length}>{typeof tx.total === 'number' ? tx.total.toFixed(2) : '0.00'} â‚¬</td>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length}><button onClick={() => toggleTransactionStatus(tx.id)} className={`p-1 rounded ${isCancelled ? 'text-yellow-500 hover:bg-yellow-100 dark:hover:bg-yellow-900/50' : 'text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50'} disabled:opacity-50 disabled:cursor-not-allowed`} title={isCancelled ? 'Restore' : 'Cancel'} disabled={!canEdit}>{isCancelled ? <UndoIcon /> : <Trash2Icon />}</button></td>
                                                        </>)}
                                                    </tr>
                                                )})}
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        });

        const BalanceDashboard = React.memo(({ transactions, profiles, addTransaction, currentUserProfile }) => {
            const [showForm, setShowForm] = useState(false);
            
            const { debts, credits, profilesById } = useMemo(() => {
                if (!currentUserProfile) return { debts: [], credits: [], profilesById: {} };

                const activeTxs = (transactions || []).filter(tx => tx.status !== 'cancelled');
                
                const profsById = profiles.reduce((acc, p) => {
                    acc[p.id] = p;
                    return acc;
                }, {});

                const balances = {};
                profiles.forEach(p1 => {
                    balances[p1.id] = {};
                    profiles.forEach(p2 => { if (p1.id !== p2.id) balances[p1.id][p2.id] = 0; });
                });

                activeTxs.forEach(tx => {
                    if (tx.buyer && tx.seller && tx.buyer !== tx.seller && balances[tx.buyer] && balances[tx.seller]) {
                        balances[tx.buyer][tx.seller] = (balances[tx.buyer][tx.seller] || 0) + tx.total;
                    }
                });

                const myDebts = [];
                const myCredits = [];

                profiles.forEach(otherUser => {
                    if (otherUser.id === currentUserProfile.id) return;

                    const iOweOther = balances[currentUserProfile.id]?.[otherUser.id] || 0;
                    const otherOwesMe = balances[otherUser.id]?.[currentUserProfile.id] || 0;
                    const netBalance = iOweOther - otherOwesMe;

                    if (netBalance > 0) {
                        myDebts.push({ to: otherUser.id, amount: netBalance });
                    } else if (netBalance < 0) {
                        myCredits.push({ from: otherUser.id, amount: -netBalance });
                    }
                });

                return { debts: myDebts, credits: myCredits, profilesById: profsById };
            }, [transactions, profiles, currentUserProfile]);
            
            const getProfileFullName = (id) => {
                const p = profilesById[id];
                if (!p) return 'Unknown';
                const fullName = `${p.first_name || ''} ${p.last_name || ''}`.trim();
                return fullName || p.nickname;
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-blue-700 dark:text-blue-400">My Balances</h1>
                        <button onClick={() => setShowForm(true)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors"><PlusCircleIcon /> Add Payment</button>
                    </div>
                    {showForm && <ManualTransactionForm profiles={profiles} addTransaction={addTransaction} onClose={() => setShowForm(false)} currentUserProfile={currentUserProfile} />}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="bg-white dark:bg-slate-900 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-slate-700">
                           <h2 className="text-xl font-semibold text-gray-800 dark:text-slate-200 mb-4">I Owe</h2>
                           {debts.length === 0 ? (
                               <p className="text-gray-500 dark:text-slate-400">You have no outstanding debts.</p>
                           ) : (
                               <ul className="space-y-3">
                                   {debts.map(debt => (
                                       <li key={debt.to} className="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                           <div className="flex items-center gap-3">
                                               <span className="font-medium text-gray-700 dark:text-slate-300">You</span>
                                               <ArrowRightIcon />
                                               <span className="font-medium text-gray-700 dark:text-slate-300" title={getProfileFullName(debt.to)}>{profilesById[debt.to]?.nickname || 'Unknown'}</span>
                                           </div>
                                           <span className="font-bold text-red-600 text-lg">{debt.amount.toFixed(2)} â‚¬</span>
                                       </li>
                                   ))}
                               </ul>
                           )}
                        </div>
                        <div className="bg-white dark:bg-slate-900 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-slate-700">
                           <h2 className="text-xl font-semibold text-gray-800 dark:text-slate-200 mb-4">Owed to Me</h2>
                           {credits.length === 0 ? (
                               <p className="text-gray-500 dark:text-slate-400">Nobody owes you money.</p>
                           ) : (
                               <ul className="space-y-3">
                                   {credits.map(credit => (
                                       <li key={credit.from} className="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                           <div className="flex items-center gap-3">
                                                <span className="font-medium text-gray-700 dark:text-slate-300" title={getProfileFullName(credit.from)}>{profilesById[credit.from]?.nickname || 'Unknown'}</span>
                                                <ArrowRightIcon />
                                                <span className="font-medium text-gray-700 dark:text-slate-300">You</span>
                                           </div>
                                           <span className="font-bold text-green-600 text-lg">{credit.amount.toFixed(2)} â‚¬</span>
                                       </li>
                                   ))}
                               </ul>
                           )}
                        </div>
                    </div>
                </div>
            );
        });

        const BalanceMatrix = React.memo(({ transactions, profiles }) => {
            const { balances } = useMemo(() => {
                const activeTxs = (transactions || []).filter(tx => tx.status !== 'cancelled');
                const bal = {};
                profiles.forEach(p1 => {
                    bal[p1.id] = {};
                    profiles.forEach(p2 => { if (p1.id !== p2.id) bal[p1.id][p2.id] = 0; });
                });
                activeTxs.forEach(tx => {
                    if (tx.buyer && tx.seller && tx.buyer !== tx.seller && bal[tx.buyer] && bal[tx.seller]) {
                        bal[tx.buyer][tx.seller] = (bal[tx.buyer][tx.seller] || 0) + tx.total;
                    }
                });
                return { balances: bal };
            }, [transactions, profiles]);

            const getProfileFullName = (profile) => {
                if (!profile) return '';
                const fullName = `${profile.first_name || ''} ${profile.last_name || ''}`.trim();
                return fullName || profile.nickname;
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-blue-700 dark:text-blue-400 mb-6">Balance Matrix</h1>
                    <p className="text-sm text-gray-600 dark:text-slate-400 mb-4">This table shows who owes whom. A positive value in cell (Row, Column) means the person in the **Row** owes money to the person in the **Column**.</p>
                    <div className="bg-white dark:bg-slate-900 rounded-lg p-4 border border-gray-200 dark:border-slate-700 shadow-sm overflow-x-auto">
                        <table className="w-full min-w-[600px] text-sm text-center">
                            <thead>
                                <tr>
                                    <th className="p-3 border-b-2 border-r border-gray-200 dark:border-slate-700 text-gray-600 dark:text-slate-400 bg-gray-50 dark:bg-slate-800 sticky left-0 z-10">â†“ Owes / Owed to â†’</th>
                                    {profiles.map(p => <th key={p.id} className="p-3 border-b-2 border-gray-200 dark:border-slate-700 text-gray-800 dark:text-slate-200 font-semibold" title={getProfileFullName(p)}>{p.nickname}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {profiles.map(buyer => (
                                    <tr key={buyer.id}>
                                        <th className="p-3 border-r border-gray-200 dark:border-slate-700 text-left font-semibold text-gray-800 dark:text-slate-200 bg-gray-50 dark:bg-slate-800 sticky left-0 z-10" title={getProfileFullName(buyer)}>{buyer.nickname}</th>
                                        {profiles.map(seller => {
                                            if (buyer.id === seller.id) return <td key={seller.id} className="p-3 bg-gray-100 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700"></td>;
                                            const netBalance = (balances[buyer.id]?.[seller.id] || 0) - (balances[seller.id]?.[buyer.id] || 0);
                                            const colorClass = netBalance > 0 ? 'text-red-600 bg-red-50 dark:bg-red-900/20' : netBalance < 0 ? 'text-green-600 bg-green-50 dark:bg-green-900/20' : 'text-gray-500 dark:text-slate-400';
                                            return <td key={seller.id} className={`p-3 border-t border-gray-200 dark:border-slate-700 font-mono font-bold ${colorClass}`}>{netBalance.toFixed(2)}</td>;
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        });

        const ManualTransactionForm = React.memo(({ profiles, addTransaction, onClose, currentUserProfile }) => {
            const [payerId, setPayerId] = useState(currentUserProfile?.id || '');
            const [receiverId, setReceiverId] = useState('');
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('Reimbursement');

            useEffect(() => {
                const otherUsers = profiles.filter(p => p.id !== currentUserProfile?.id);
                if(otherUsers.length > 0) {
                    setReceiverId(otherUsers[0].id);
                }
            }, [profiles, currentUserProfile]);

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                const finalAmount = parseFloat(amount);
                if (!payerId || !receiverId || !finalAmount || finalAmount <= 0) {
                    alert('Please fill all fields with valid values.'); return;
                }
                if (payerId === receiverId) {
                    alert('Payer and Receiver cannot be the same person.'); return;
                }
                addTransaction({
                    buyer: receiverId, seller: payerId,
                    cards: [{ id: `manual_${Date.now()}`, name: description, finish: 'manual', marketPrice: finalAmount, finalPrice: finalAmount, cartItemId: `manual_item_${Date.now()}` }],
                    total: finalAmount, status: 'active'
                });
                onClose();
            }, [payerId, receiverId, amount, description, addTransaction, onClose]);

            return (
                <div className="bg-white dark:bg-slate-900 rounded-lg p-6 mb-6 border border-gray-200 dark:border-slate-700 shadow-sm">
                    <h2 className="text-xl font-semibold mb-4 text-blue-700 dark:text-blue-400">Record a Manual Payment</h2>
                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div className="text-gray-700 dark:text-slate-300">
                            <label className="block text-sm font-medium mb-1">Who pays?</label>
                            <select value={payerId} onChange={e => setPayerId(e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2">
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                            </select>
                        </div>
                        <div className="text-gray-700 dark:text-slate-300">
                            <label className="block text-sm font-medium mb-1">Who receives?</label>
                            <select value={receiverId} onChange={e => setReceiverId(e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2">
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                            </select>
                        </div>
                        <div className="text-gray-700 dark:text-slate-300">
                            <label className="block text-sm font-medium mb-1">Amount (â‚¬)</label>
                            <input type="number" value={amount} onChange={e => setAmount(e.target.value)} step="0.01" className="w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg p-2" />
                        </div>
                        <div className="md:col-span-4 flex justify-end gap-4 mt-2">
                            <button type="button" onClick={onClose} className="bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 text-gray-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                            <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save</button>
                        </div>
                    </form>
                </div>
            );
        });

        // --- Final Render ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
