<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The TAB - MTG UBI ANN</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Supabase Configuration and Client ---
        const supabaseUrl = "https://pnnmxmfstynzyhvdfdyw.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBubm14bWZzdHluenlodmRmZHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyOTU1NjQsImV4cCI6MjA2ODg3MTU2NH0.fzuomyiBGqk07noz_qW0dmZAqg3eulpXQiczoE26DWU";
        const { createClient } = supabase; 
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // --- SVG Icons ---
        const SearchIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;
        const Trash2Icon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const PlusCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>;
        const ScaleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 16.5l4-4-4-4"></path><path d="M8 7.5l-4 4 4 4"></path><path d="M2 11.5h20"></path><path d="M12 3v18"></path></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const ExternalLinkIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block ml-1 opacity-60"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>;
        const UndoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>;
        const LogOutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const ArrowRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>;

        // --- Auth Component ---
        function Auth({ supabase }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nickname, setNickname] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isSignUp, setIsSignUp] = useState(false);

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                try {
                    let response;
                    if (isSignUp) {
                        if (!nickname.trim()) throw new Error("Nickname is required.");
                        response = await supabase.auth.signUp({ 
                            email, 
                            password,
                            options: {
                                data: {
                                    nickname: nickname.trim()
                                }
                            }
                        });
                    } else {
                        response = await supabase.auth.signInWithPassword({ email, password });
                    }
                    if (response.error) throw response.error;
                } catch (error) {
                    if (error.message.includes('profiles_nickname_key')) {
                        setError('This nickname is already taken. Please choose another one.');
                    } else {
                        setError(error.error_description || error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center">
                    <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
                        <h2 className="text-3xl font-bold text-center text-blue-700 mb-6">{isSignUp ? 'Create Account' : 'Sign In'}</h2>
                        {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</p>}
                        <form onSubmit={handleAuthAction} className="space-y-6">
                            {isSignUp && (
                                <div>
                                    <label htmlFor="nickname" className="text-sm font-medium text-gray-700">Nickname</label>
                                    <input id="nickname" name="nickname" type="text" required maxLength="25" value={nickname} onChange={(e) => setNickname(e.target.value)}
                                        className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                </div>
                            )}
                            <div>
                                <label htmlFor="email" className="text-sm font-medium text-gray-700">Email address</label>
                                <input id="email" name="email" type="email" required value={email} onChange={(e) => setEmail(e.target.value)}
                                    className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                            </div>
                            <div>
                                <label htmlFor="password"className="text-sm font-medium text-gray-700">Password</label>
                                <input id="password" name="password" type="password" required value={password} onChange={(e) => setPassword(e.target.value)}
                                    className="mt-1 w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                            </div>
                            <div>
                                <button type="submit" disabled={loading}
                                    className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-400">
                                    {loading ? 'Processing...' : (isSignUp ? "Sign Up" : 'Sign In')}
                                </button>
                            </div>
                        </form>
                        <p className="mt-6 text-center text-sm text-gray-600">
                            {isSignUp ? 'Already have an account?' : "Don't have an account?"}
                            <button onClick={() => { setIsSignUp(!isSignUp); setError(null); }} className="font-medium text-blue-600 hover:text-blue-500 ml-1">
                                {isSignUp ? 'Sign In' : "Sign Up"}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        // --- Main App Component ---
        function App() {
            const [session, setSession] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setIsLoading(false);
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                });

                return () => subscription.unsubscribe();
            }, []);

            if (isLoading) {
                return <div className="text-center p-10">Initializing...</div>;
            }

            if (!session) {
                return <Auth supabase={supabaseClient} />;
            } else {
                return <TheTabApp user={session.user} />;
            }
        }

        function TheTabApp({ user }) {
          const [profiles, setProfiles] = useState([]);
          const [currentUserProfile, setCurrentUserProfile] = useState(null);
          const [transactions, setTransactions] = useState([]);
          const [cart, setCart] = useState([]);
          const [currentView, setCurrentView] = useState('search');
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);

          const fetchData = useCallback(async () => {
              setIsLoading(true);
              setError(null);
              try {
                  const { data: profilesData, error: profilesError } = await supabaseClient.from('profiles').select('*');
                  if (profilesError) throw profilesError;
                  setProfiles(profilesData);

                  const profile = profilesData.find(p => p.id === user.id);
                  setCurrentUserProfile(profile);

                  const { data: transactionsData, error: transactionsError } = await supabaseClient.from('transactions').select('*');
                  if (transactionsError) throw transactionsError;
                  setTransactions(transactionsData);
              } catch (err) {
                  console.error("Data fetching error:", err.message);
                  setError('Could not fetch data from the database.');
              } finally {
                  setIsLoading(false);
              }
          }, [user.id]);

          useEffect(() => {
              fetchData();
          }, [fetchData]);

          const handleSignOut = async () => {
              await supabaseClient.auth.signOut();
          };

          const handleProfileUpdate = (updatedProfile) => {
            setCurrentUserProfile(updatedProfile);
            setProfiles(prevProfiles => prevProfiles.map(p => p.id === updatedProfile.id ? updatedProfile : p));
          };

          // --- Cart and Transaction Callbacks ---
          const addToCart = useCallback((card) => { setCart(prev => [...prev, { ...card, finalPrice: card.price || 0, cartItemId: Date.now() + Math.random() }]); }, []);
          const removeFromCart = useCallback((id) => { setCart(prev => prev.filter(item => item.cartItemId !== id)); }, []);
          const updateCartItemPrice = useCallback((id, price) => { setCart(prev => prev.map(item => item.cartItemId === id ? { ...item, finalPrice: price } : item)); }, []);

          const addTransaction = useCallback(async (tx) => {
            try {
              const { data, error } = await supabaseClient.from('transactions').insert([tx]).select();
              if (error) throw error;
              setTransactions(prev => [...prev, data[0]]);
              setCart([]);
              setCurrentView('transactions');
            } catch (e) { alert("Error: " + e.message); }
          }, []);

          const updateTransactionCardPrice = useCallback(async (txId, itemId, price) => {
            setTransactions(prev => {
              const newTxs = [...prev];
              const tx = newTxs.find(t => t.id === txId);
              if (!tx) return prev;
              const updatedCards = tx.cards.map(c => c.cartItemId === itemId ? { ...c, finalPrice: parseFloat(price) || 0 } : c);
              const newTotal = updatedCards.reduce((sum, c) => sum + (c.finalPrice || 0), 0);
              supabaseClient.from('transactions').update({ cards: updatedCards, total: newTotal }).eq('id', txId).then(r => { if (r.error) alert(r.error.message); });
              return newTxs.map(t => t.id === txId ? { ...t, cards: updatedCards, total: newTotal } : t);
            });
          }, []);

          const toggleTransactionStatus = useCallback(async (txId) => {
            const tx = transactions.find(t => t.id === txId);
            if (!tx) return;
            const newStatus = tx.status === 'cancelled' ? 'active' : 'cancelled';
            try {
              const { data, error } = await supabaseClient.from('transactions').update({ status: newStatus }).eq('id', txId).select();
              if (error) throw error;
              setTransactions(prev => prev.map(t => t.id === txId ? data[0] : t));
            } catch (e) { alert("Error: " + e.message); }
          }, [transactions]);

          const renderView = () => {
            if (isLoading) return <div className="text-center p-10">Loading data...</div>;
            if (error) return <div className="text-center text-red-500 p-10">{error}</div>;
            switch (currentView) {
              case 'search': return <SearchAndCartView {...{ cart, addToCart, removeFromCart, updateCartItemPrice, profiles, addTransaction }} />;
              case 'transactions': return <TransactionsView {...{ transactions, profiles, updateTransactionCardPrice, toggleTransactionStatus }} />;
              case 'balance': return <BalanceDashboard {...{ transactions, profiles, addTransaction }} />;
              case 'profile': return <ProfileView user={user} profile={currentUserProfile} onProfileUpdate={handleProfileUpdate} />;
              default: return <div>Welcome</div>;
            }
          };

          return (
            <div className="bg-white text-gray-800 h-screen font-sans flex overflow-hidden">
              <nav className="p-4 bg-white border-r border-gray-200 flex flex-col items-center space-y-4 shrink-0 shadow-md">
                <div className="flex-grow">
                    <button onClick={() => setCurrentView('search')} className={`p-3 rounded-lg ${currentView === 'search' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`} title="Search & Cart"><SearchIcon /></button>
                    <button onClick={() => setCurrentView('transactions')} className={`p-3 mt-2 rounded-lg ${currentView === 'transactions' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`} title="Transactions"><ListIcon /></button>
                    <button onClick={() => setCurrentView('balance')} className={`p-3 mt-2 rounded-lg ${currentView === 'balance' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`} title="Balances"><ScaleIcon /></button>
                    <button onClick={() => setCurrentView('profile')} className={`p-3 mt-2 rounded-lg ${currentView === 'profile' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`} title="Profile"><UserIcon /></button>
                </div>
                <div className="shrink-0 text-center">
                    {currentUserProfile && (
                        <div className="mb-2 px-2">
                            <span className="text-xs text-gray-500">Logged in as</span>
                            <span className="text-sm font-semibold text-blue-700 block truncate" title={currentUserProfile.nickname}>
                                {currentUserProfile.nickname}
                            </span>
                        </div>
                    )}
                    <button onClick={handleSignOut} className="p-3 rounded-lg text-gray-600 hover:bg-gray-100" title="Sign Out"><LogOutIcon /></button>
                </div>
              </nav>
              <main className="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto bg-gray-50">{renderView()}</main>
            </div>
          );
        }

        // --- Profile View Component ---
        const ProfileView = ({ user, profile, onProfileUpdate }) => {
            const [nickname, setNickname] = useState(profile?.nickname || '');
            const [firstName, setFirstName] = useState(profile?.first_name || '');
            const [lastName, setLastName] = useState(profile?.last_name || '');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            useEffect(() => {
                setNickname(profile?.nickname || '');
                setFirstName(profile?.first_name || '');
                setLastName(profile?.last_name || '');
            }, [profile]);

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                try {
                    const updates = {
                        id: user.id,
                        nickname: nickname.trim(),
                        first_name: firstName.trim(),
                        last_name: lastName.trim(),
                        updated_at: new Date(),
                    };
                    const { data, error } = await supabaseClient.from('profiles').upsert(updates).select().single();
                    if (error) throw error;
                    onProfileUpdate(data);
                    setMessage('Profile updated successfully!');
                } catch (error) {
                    if (error.message.includes('profiles_nickname_key')) {
                      setMessage('Error: This nickname is already taken.');
                    } else {
                      setMessage('Error: ' + error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-blue-700 mb-6">My Profile</h1>
                    <div className="max-w-2xl bg-white p-8 rounded-lg shadow-sm border border-gray-200">
                        <form onSubmit={handleUpdateProfile} className="space-y-6">
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email</label>
                                <input id="email" type="text" value={user.email} disabled className="mt-1 w-full p-3 bg-gray-200 border border-gray-300 rounded-lg cursor-not-allowed"/>
                            </div>
                            <div>
                                <label htmlFor="profile-nickname" className="block text-sm font-medium text-gray-700">Nickname</label>
                                <input id="profile-nickname" type="text" value={nickname} onChange={(e) => setNickname(e.target.value)} required maxLength="25" className="mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label htmlFor="firstName" className="block text-sm font-medium text-gray-700">First Name</label>
                                    <input id="firstName" type="text" value={firstName} onChange={(e) => setFirstName(e.target.value)} className="mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                </div>
                                <div>
                                    <label htmlFor="lastName" className="block text-sm font-medium text-gray-700">Last Name</label>
                                    <input id="lastName" type="text" value={lastName} onChange={(e) => setLastName(e.target.value)} className="mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"/>
                                </div>
                            </div>
                            <div className="flex items-center justify-end gap-4">
                                {message && <p className={`text-sm ${message.includes('Error') ? 'text-red-600' : 'text-green-600'}`}>{message}</p>}
                                <button type="submit" disabled={loading} className="py-2 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors disabled:bg-blue-400">
                                    {loading ? 'Saving...' : 'Save'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Other components (Search, Cart, Transactions, Balance) ---
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
                return () => { clearTimeout(handler); };
            }, [value, delay]);
            return debouncedValue;
        }

        const SearchAndCartView = React.memo(({ cart, addToCart, removeFromCart, updateCartItemPrice, profiles, addTransaction }) => {
          const [searchResults, setSearchResults] = useState([]);
          const [query, setQuery] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);
          const debouncedQuery = useDebounce(query, 500);

          const handleSearch = useCallback(async (searchQuery) => {
            if (!searchQuery) { setSearchResults([]); return; };
            setIsLoading(true); setError(null);
            try {
              const response = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(`${searchQuery.trim()} unique:prints`)}`);
              if (!response.ok) { const errData = await response.json(); throw new Error(errData.details || 'Card not found.'); }
              const data = await response.json();
              const processedResults = data.data.flatMap(card => 
                card.finishes.map(finish => ({
                  id: card.id, name: card.name, set_name: card.set_name, set: card.set, collector_number: card.collector_number, rarity: card.rarity, finish: finish,
                  price: finish === 'foil' ? card.prices.eur_foil : card.prices.eur,
                  image_uri: card.image_uris?.small || 'https://placehold.co/146x204/e0e7ff/3730a3?text=No+Image',
                  scryfall_uri: card.scryfall_uri, purchase_uris: card.purchase_uris
                }))
              );
              setSearchResults(processedResults);
            } catch (err) { setError(err.message); setSearchResults([]); }
            setIsLoading(false);
          }, []);

          useEffect(() => { handleSearch(debouncedQuery); }, [debouncedQuery, handleSearch]);

          return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-2">
                <h1 className="text-3xl font-bold text-blue-700 mb-4">Card Search</h1>
                <div className="flex gap-2 mb-4">
                  <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} placeholder='Start typing a card name...' className="flex-grow bg-white border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none text-gray-900"/>
                </div>
                <div className="bg-white rounded-lg p-4 border border-gray-200 shadow-sm min-h-[60vh]">
                  {isLoading && <p className="text-gray-500 text-center py-12">Searching...</p>}
                  {error && <p className="text-red-600 text-center py-12">{error}</p>}
                  {!isLoading && searchResults.length === 0 && !error && <p className="text-gray-500 text-center py-12">Search results will be displayed here.</p>}
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    {searchResults.map(card => (
                      <div key={`${card.id}-${card.finish}`} className="bg-gray-50 rounded-lg p-2 flex flex-col items-center text-center border border-gray-200 hover:shadow-md transition-shadow">
                        <a href={card.scryfall_uri} target="_blank" rel="noopener noreferrer"><img src={card.image_uri} alt={card.name} className="rounded-md w-full mb-2" /></a>
                        <h3 className="font-semibold text-sm text-gray-900">{card.name} {card.finish === 'foil' && <span className="text-blue-500">(Foil)</span>}</h3>
                        <p className="text-xs text-gray-500">{card.set_name}</p>
                        <p className="font-bold text-blue-600 text-sm my-1">{card.price ? `${card.price} €` : 'N/A'}</p>
                        <button onClick={() => addToCart(card)} className="bg-blue-500 text-white text-xs w-full py-1 rounded-md mt-auto hover:bg-blue-600 transition-colors">Add to Cart</button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              <div className="lg:sticky lg:top-8 h-fit">
                <h2 className="text-2xl font-bold text-blue-700 mb-4 flex items-center"><span className="ml-2">Cart</span></h2>
                <Cart cart={cart} removeFromCart={removeFromCart} updateCartItemPrice={updateCartItemPrice} profiles={profiles} addTransaction={addTransaction} />
              </div>
            </div>
          );
        });

        const Cart = React.memo(({ cart, removeFromCart, updateCartItemPrice, profiles, addTransaction }) => {
            const [buyerId, setBuyerId] = useState('');
            const [sellerId, setSellerId] = useState('');

            useEffect(() => {
                if (profiles.length > 0) {
                    if (!buyerId) setBuyerId(profiles[0].id);
                    if (!sellerId && profiles.length > 1) setSellerId(profiles[1].id);
                }
            }, [profiles, buyerId, sellerId]);

            const handleRecordTransaction = useCallback(() => {
                if (!buyerId || !sellerId || cart.length === 0) {
                    alert('Please select a buyer, a seller, and at least one card.'); return;
                }
                if (buyerId === sellerId) {
                    alert("Buyer and Seller cannot be the same person."); return;
                }
                const newTransaction = {
                    buyer: buyerId, seller: sellerId,
                    cards: cart.map(c => ({ ...c, marketPrice: parseFloat(c.price) || 0, finalPrice: parseFloat(c.finalPrice) || 0 })),
                    total: cart.reduce((sum, c) => sum + (parseFloat(c.finalPrice) || 0), 0),
                    status: 'active'
                };
                addTransaction(newTransaction);
            }, [buyerId, sellerId, cart, addTransaction]);

            const total = useMemo(() => cart.reduce((sum, c) => sum + (parseFloat(c.finalPrice) || 0), 0).toFixed(2), [cart]);

            return (
                <div className="bg-white rounded-lg p-4 flex flex-col border border-gray-200 shadow-sm max-h-[calc(100vh-8rem)]">
                    <div className="flex-grow overflow-y-auto mb-4 pr-2">
                        {cart.length === 0 ? <p className="text-gray-500 text-center mt-8">Your cart is empty.</p> :
                            <ul className="space-y-3">
                                {cart.map(card => (
                                    <li key={card.cartItemId} className="flex items-center justify-between bg-gray-100 p-2 rounded-lg">
                                        <div className="text-sm flex-grow">
                                            <p className="font-semibold text-gray-900">{card.name} {card.finish === 'foil' && <span className="text-blue-500">(Foil)</span>}</p>
                                            <p className="text-xs text-gray-500">{card.set_name}</p>
                                        </div>
                                        <div className="flex items-center">
                                            <input type="number" value={card.finalPrice} onChange={(e) => updateCartItemPrice(card.cartItemId, e.target.value)} className="w-20 bg-white border border-gray-300 rounded-md p-1 text-right font-mono text-gray-900" step="0.01" />
                                            <span className="ml-1 mr-2 text-gray-600">€</span>
                                            <button onClick={() => removeFromCart(card.cartItemId)} className="text-red-500 hover:text-red-700"><Trash2Icon /></button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        }
                    </div>
                    {cart.length > 0 && (
                        <div className="border-t border-gray-200 pt-4 shrink-0">
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-gray-700">Buyer</label>
                                    <select value={buyerId} onChange={e => setBuyerId(e.target.value)} className="w-full bg-white border border-gray-300 rounded-lg p-2 text-gray-900">
                                        {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-gray-700">Seller</label>
                                    <select value={sellerId} onChange={e => setSellerId(e.target.value)} className="w-full bg-white border border-gray-300 rounded-lg p-2 text-gray-900">
                                        {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="text-right font-bold text-xl mb-4 text-gray-900">Total: {total} €</div>
                            <button onClick={handleRecordTransaction} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">Record Transaction</button>
                        </div>
                    )}
                </div>
            );
        });

        const TransactionsView = React.memo(({ transactions, profiles, updateTransactionCardPrice, toggleTransactionStatus }) => {
            const profilesById = useMemo(() => profiles.reduce((acc, profile) => {
                acc[profile.id] = profile;
                return acc;
            }, {}), [profiles]);

            const getProfileNickname = (id) => profilesById[id]?.nickname || 'Unknown User';

            return (
                <div>
                    <h1 className="text-3xl font-bold text-blue-700 mb-6">Transaction History</h1>
                    <div className="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-500 uppercase bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3">Date</th><th className="px-4 py-3">Buyer</th><th className="px-4 py-3">Seller</th>
                                        <th className="px-4 py-3">Card</th><th className="px-4 py-3">Set</th><th className="px-4 py-3">Final Price</th>
                                        <th className="px-4 py-3 text-right">Total</th><th className="px-4 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {transactions.slice().reverse().map(tx => {
                                        const isCancelled = tx.status === 'cancelled';
                                        return (
                                            <React.Fragment key={tx.id}>
                                                {(tx.cards || []).map((c, index) => (
                                                    <tr key={c.cartItemId || `${c.id}-${c.finish}`} className={`${isCancelled ? 'opacity-40 bg-gray-100' : 'hover:bg-gray-50'}`}>
                                                        {index === 0 && (<>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length}>{new Date(tx.created_at).toLocaleDateString('en-GB')}</td>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length}>{getProfileNickname(tx.buyer)}</td>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length}>{getProfileNickname(tx.seller)}</td>
                                                        </>)}
                                                        <td className="px-4 py-4"><a href={c.scryfall_uri} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">{c.name} {c.finish === 'foil' && '(Foil)'} {c.scryfall_uri && <ExternalLinkIcon />}</a></td>
                                                        <td className="px-4 py-4 text-gray-600">{c.set || c.set_name}</td>
                                                        <td className="px-4 py-4">
                                                            <div className="flex items-center">
                                                                <input type="number" defaultValue={c.finalPrice} onBlur={(e) => updateTransactionCardPrice(tx.id, c.cartItemId, e.target.value)} className="w-20 bg-white border border-gray-300 rounded-md p-1 text-right font-mono" step="0.01" disabled={isCancelled} />
                                                                <span className="ml-1 text-gray-600">€</span>
                                                            </div>
                                                        </td>
                                                        {index === 0 && (<>
                                                            <td className="px-4 py-4 text-right font-mono" rowSpan={tx.cards.length}>{typeof tx.total === 'number' ? tx.total.toFixed(2) : '0.00'} €</td>
                                                            <td className="px-4 py-4" rowSpan={tx.cards.length}><button onClick={() => toggleTransactionStatus(tx.id)} className={`p-1 rounded ${isCancelled ? 'text-yellow-500 hover:bg-yellow-100' : 'text-red-500 hover:bg-red-100'}`} title={isCancelled ? 'Restore' : 'Cancel'}>{isCancelled ? <UndoIcon /> : <Trash2Icon />}</button></td>
                                                        </>)}
                                                    </tr>
                                                ))}
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        });

        const BalanceDashboard = React.memo(({ transactions, profiles, addTransaction }) => {
            const [showForm, setShowForm] = useState(false);
            
            const { balances, profilesById } = useMemo(() => {
                const activeTxs = (transactions || []).filter(tx => tx.status !== 'cancelled');
                
                const profsById = profiles.reduce((acc, p) => {
                    acc[p.id] = p;
                    return acc;
                }, {});

                const bal = {};
                profiles.forEach(p1 => {
                    bal[p1.id] = {};
                    profiles.forEach(p2 => { if (p1.id !== p2.id) bal[p1.id][p2.id] = 0; });
                });

                activeTxs.forEach(tx => {
                    if (tx.buyer && tx.seller && tx.buyer !== tx.seller && bal[tx.buyer] && bal[tx.seller]) {
                        bal[tx.buyer][tx.seller] = (bal[tx.buyer][tx.seller] || 0) + tx.total;
                    }
                });
                return { balances: bal, profilesById: profsById };
            }, [transactions, profiles]);

            const netBalances = useMemo(() => {
                const net = {};
                for (let i = 0; i < profiles.length; i++) {
                    for (let j = i + 1; j < profiles.length; j++) {
                        const p1_id = profiles[i].id;
                        const p2_id = profiles[j].id;
                        const p1_owes_p2 = balances[p1_id]?.[p2_id] || 0;
                        const p2_owes_p1 = balances[p2_id]?.[p1_id] || 0;
                        const netBalance = p1_owes_p2 - p2_owes_p1;
                        
                        if (netBalance > 0) { // p1 owes p2
                            if (!net[p1_id]) net[p1_id] = [];
                            net[p1_id].push({ to: p2_id, amount: netBalance });
                        } else if (netBalance < 0) { // p2 owes p1
                            if (!net[p2_id]) net[p2_id] = [];
                            net[p2_id].push({ to: p1_id, amount: -netBalance });
                        }
                    }
                }
                return net;
            }, [balances, profiles]);

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-blue-700">Balances</h1>
                        <button onClick={() => setShowForm(true)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors"><PlusCircleIcon /> Add Payment</button>
                    </div>
                    {showForm && <ManualTransactionForm profiles={profiles} addTransaction={addTransaction} onClose={() => setShowForm(false)} />}
                    
                    <div className="space-y-6">
                        {profiles.length > 0 ? profiles.map(person => (
                            <div key={person.id} className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">{person.nickname}'s Debts</h2>
                                {(!netBalances[person.id] || netBalances[person.id].length === 0) ? (
                                    <p className="text-gray-500">This person has no outstanding debts.</p>
                                ) : (
                                    <ul className="space-y-3">
                                        {netBalances[person.id].map(debt => (
                                            <li key={`${person.id}-${debt.to}`} className="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                                <div className="flex items-center gap-3">
                                                    <span className="font-medium text-gray-700">{person.nickname}</span>
                                                    <ArrowRightIcon />
                                                    <span className="font-medium text-gray-700">{profilesById[debt.to]?.nickname || 'Unknown'}</span>
                                                </div>
                                                <span className="font-bold text-red-600 text-lg">{debt.amount.toFixed(2)} €</span>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        )) : (
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 text-center">
                                <p className="text-gray-500">No users found.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        });

        const ManualTransactionForm = React.memo(({ profiles, addTransaction, onClose }) => {
            const [payerId, setPayerId] = useState(profiles[0]?.id || '');
            const [receiverId, setReceiverId] = useState(profiles[1]?.id || '');
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('Reimbursement');

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                const finalAmount = parseFloat(amount);
                if (!payerId || !receiverId || !finalAmount || finalAmount <= 0) {
                    alert('Please fill all fields with valid values.'); return;
                }
                if (payerId === receiverId) {
                    alert('Payer and Receiver cannot be the same person.'); return;
                }
                addTransaction({
                    buyer: receiverId, seller: payerId,
                    cards: [{ id: `manual_${Date.now()}`, name: description, finish: 'manual', marketPrice: finalAmount, finalPrice: finalAmount, cartItemId: `manual_item_${Date.now()}` }],
                    total: finalAmount, status: 'active'
                });
                onClose();
            }, [payerId, receiverId, amount, description, addTransaction, onClose]);

            return (
                <div className="bg-white rounded-lg p-6 mb-6 border border-gray-200 shadow-sm">
                    <h2 className="text-xl font-semibold mb-4 text-blue-700">Record a Manual Payment</h2>
                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">Who pays?</label>
                            <select value={payerId} onChange={e => setPayerId(e.target.value)} className="w-full bg-white border border-gray-300 rounded-lg p-2 text-gray-900">
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">Who receives?</label>
                            <select value={receiverId} onChange={e => setReceiverId(e.target.value)} className="w-full bg-white border border-gray-300 rounded-lg p-2 text-gray-900">
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.nickname}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700">Amount (€)</label>
                            <input type="number" value={amount} onChange={e => setAmount(e.target.value)} step="0.01" className="w-full bg-white border border-gray-300 rounded-lg p-2 text-gray-900" />
                        </div>
                        <div className="md:col-span-4 flex justify-end gap-4 mt-2">
                            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                            <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save</button>
                        </div>
                    </form>
                </div>
            );
        });

        // --- Final Render ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
